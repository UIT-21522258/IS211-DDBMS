
/*
2152225 - Nguye Tran Gia Kiet
21521897 - Thi Thanh Cong'
21522541 - Cao HOai Sang
21522684 - Tran Thanh Tin
*/
create user admin identified by admin;


grant create session, create table, unlimited tablespace, create procedure, create trigger, create database link, connect, create role, create view to admin;


connect admin/admin;

create table DONVI(
    MADV VARCHAR2(20) NOT NULL PRIMARY KEY,
    TENDV VARCHAR2(50),
    SLTV NUMBER,
    CAP VARCHAR2(50),
    SNHT NUMBER,
    SDT VARCHAR2(50));

 CREATE TABLE KHOANGCACH(
    MaDV1 VARCHAR2(20) NOT NULL,
    MaDV2 VARCHAR2(20) NOT NULL,
    NgChuyen VARCHAR(50),
    PRIMARY KEY (MaDV1, MaDV2));


 CREATE TABLE LOAICAY(
    MALC VARCHAR2(20) NOT NULL PRIMARY KEY,
    TENLC VARCHAR2(50),
    MADV VARCHAR2(20),
    TOCDO VARCHAR(50),
    VITRI VARCHAR(50),
    SLBD NUMBER,
    SLCL NUMBER);


CREATE TABLE DANGKY(
    MADK VARCHAR2(20) NOT NULL PRIMARY KEY,
    MADV VARCHAR2(20),
    MALC VARCHAR2(20),
    NGDK DATE,
    CHITIEU NUMBER,
    SLHT NUMBER);


 CREATE TABLE TIENDO(
    MADK VARCHAR2(20) NOT NULL PRIMARY KEY,
    SLTHEM NUMBER,
    NGBC DATE);



ALTER TABLE KHOANGCACH ADD CONSTRAINT FK_KCDV FOREIGN KEY (MaDV1) REFERENCES DONVI(MaDV);

ALTER TABLE KHOANGCACH ADD CONSTRAINT FK_KCDV2 FOREIGN KEY (MaDV2) REFERENCES DONVI(MaDV);

ALTER TABLE LOAICAY ADD CONSTRAINT FK_LCDV FOREIGN KEY (MADV) REFERENCES DONVI(MaDV);

ALTER TABLE DANGKY ADD CONSTRAINT FK_DKDV FOREIGN KEY (MADV) REFERENCES DONVI(MaDV);

ALTER TABLE DANGKY ADD CONSTRAINT FK_DKLC FOREIGN KEY (MALC) REFERENCES LOAICAY(MaLC);

ALTER TABLE TIENDO ADD CONSTRAINT FK_TDDK FOREIGN KEY (MADK) REFERENCES DANGKY(MADK);

create role role_DV

-Grant quyen

grant update on admin.LOAICAY to role_DV;
grant insert on admin.DANGKY to role_DV;
grant insert on admin.TIENDO to role_DV;
grant insert on admin.TIENDO to role_DV;
grant select on admin.DONVI to role_DV;
grant select on admin.KHOANGCACH to role_DV;
grant select on admin.LOAICAY to role_DV;
grant select on admin.DANGKY to role_DV;
grant select on admin.TIENDO to role_DV;

create user TRUONGDV identified by TRUONGDV;
grant role_DV to TRUONGDV;

INSERT INTO DONVI VALUES('01', 'DV1', 5, '1', 8, '0123456789');
INSERT INTO DONVI VALUES('02', 'DV2', 4, '2', 9,'0223456789');
INSERT INTO DONVI VALUES('03', 'DV3', 3, '3', 10, '0323456789');

INSERT INTO KHOANGCACH VALUES('01','02','Nguyen Van A');
INSERT INTO KHOANGCACH VALUES('01','03','Tran Tien B');
INSERT INTO KHOANGCACH VALUES('02','03','Pham Hai C');

INSERT INTO LOAICAY VALUES('11','Buoi','01', 5, 'Khu A' , 50, 8);
INSERT INTO LOAICAY VALUES('12','Mit','02', 3, 'Khu B' , 30, 2);
INSERT INTO LOAICAY VALUES('13','Tao','03', 1, 'Khu C' , 20, 0);

INSERT INTO DANGKY VALUES('21','01', '11', '01/02/2006', 'CSDL', 5);
INSERT INTO DANGKY VALUES('22','02', '12', '23/02/2006', 'KHMT', 2);
INSERT INTO DANGKY VALUES('23','03', '13', '12/02/2006', 'HDH', 7);

INSERT INTO TIENDO VALUES('21',2, '28/02/2006');
INSERT INTO TIENDO VALUES('22',6, '4/03/2006');
INSERT INTO TIENDO VALUES('23',9, '25/02/2006');

CREATE OR REPLACE PROCEDURE THEMDANGKY(MDV IN admin.loaicay.MADV%TYPE) AS
    CT NUMBER,
    MLC admin.LOAICAY.MALC%TYPE
    BEGIN
    SELECT MALC,CHITIEU INTO MLC, CT FROM DANGKY WHERE DANGKY.MADV = MDV;
    UPDATE LOAICAY SET SLCL = SLCL - CT WHERE LOAICAY.MALC = MLC;
    END;
    /

CREATE OR REPLACE TRIGGER TRIGGER1
BEFORE INSERT OR UPDATE ON admin.DANGKY
FOR EACH ROW
BEGIN
	THEMDANGKY(:NEW.MADV);
END;
/

grant execute on TRIGGER1 to role_DV;


create or replace procedure CapNhatSNHT(mdv IN admin.LOAICAY.MADV%TYPE)
AS
BEGIN

